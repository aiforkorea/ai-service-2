{# apps/adminx/templates/adminx/manage_users.html #}
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1 class="mb-4">사용자 관리</h1>

{# 검색 폼과 사용자 생성 버튼을 포함하는 하나의 행 #}
<div class="row mb-3 align-items-end"> {# align-items-end: 행 내부 요소를 아래쪽에 정렬합니다. #}
    {# 검색 폼 영역: 데스크톱에서는 9/12 컬럼, 모바일에서는 12/12 컬럼 #}
    <div class="col-md-9 col-12">
        <form action="{{ url_for('adminx.manage_users') }}" method="GET">
            <div class="row g-2"> {# 각 검색 필드와 버튼 간의 간격(gutter)을 설정 #}
                <div class="col-md-4 col-12">
                    <input type="search" name="search" class="form-control" placeholder="사용자 이름 또는 이메일 검색"
                           value="{{ search_query if search_query }}" aria-label="Search">
                </div>
                <div class="col-md-2 col-6">
                    <select name="is_admin" class="form-select">
                        <option value="">관리자 여부</option>
                        <option value="true" {% if is_admin_query == 'true' %}selected{% endif %}>관리자</option>
                        <option value="false" {% if is_admin_query == 'false' %}selected{% endif %}>일반</option>
                    </select>
                </div>
                <div class="col-md-2 col-6">
                    <select name="is_active" class="form-select">
                        <option value="">활성 상태</option>
                        <option value="true" {% if is_active_query == 'true' %}selected{% endif %}>활성</option>
                        <option value="false" {% if is_active_query == 'false' %}selected{% endif %}>비활성</option>
                    </select>
                </div>
                <div class="col-md-2 col-12">
                    <input type="date" name="created_at" class="form-control" placeholder="가입일"
                           value="{{ created_at_query if created_at_query }}" aria-label="Registration Date">
                </div>
                <div class="col-md-2 col-12 d-grid"> {# d-grid: 모바일에서 버튼이 부모 컬럼의 전체 너비를 차지하도록 함 #}
                    <button class="btn btn-primary" type="submit">검색</button>
                </div>
            </div>
        </form>
    </div>
    {# "사용자 생성" 버튼 영역: 데스크톱에서는 3/12 컬럼, 모바일에서는 12/12 컬럼 #}
    <div class="col-md-3 col-12 mt-2 mt-md-0 d-grid d-md-block text-md-end">
        <a href="{{ url_for('adminx.create_user') }}" class="btn btn-primary user-create-btn">사용자 생성</a>
    </div>
</div>

{% if users %}
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-primary">
            <tr>
                <th scope="col">ID</th>
                <th scope="col">사용자 이름</th>
                <th scope="col">이메일</th>
                <th scope="col">관리자 여부</th>
                <th scope="col">활성 상태</th>
                <th scope="col">총 사용 횟수</th>
                <th scope="col">가입일</th>
                <th scope="col">활성화</th>
                <th scope="col">관리자</th>
                <th scope="col">수정</th>
                <th scope="col">삭제</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.is_admin %}
                        <span class="badge bg-danger">관리자</span>
                    {% else %}
                        <span class="badge bg-secondary">일반</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                        <span class="badge bg-success">활성</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">비활성</span>
                    {% endif %}
                </td>
                <td>{{ user.usage_count }}</td>
                <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                    {% if user.id != current_user.id %}
                        <form method="POST" action="{{ url_for('adminx.toggle_user_active', user_id=user.id, search=search_query, page=pagination.page, is_admin=is_admin_query, is_active=is_active_query, created_at=created_at_query) }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm {% if user.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                                    onclick="return confirm('이 사용자의 계정 상태를 변경하시겠습니까?');">
                                {{ '비활성화' if user.is_active else '활성화' }}
                            </button>
                        </form>
                    {% else %}
                        <small class="text-muted">자기계정</small>
                    {% endif %}
                </td>
                <td>
                    {% if user.id != current_user.id %}
                        <form method="POST" action="{{ url_for('adminx.toggle_user_admin', user_id=user.id, search=search_query, page=pagination.page, is_admin=is_admin_query, is_active=is_active_query, created_at=created_at_query) }}" style="display:inline;" class="ms-1">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm {% if user.is_admin %}btn-outline-danger{% else %}btn-outline-info{% endif %}"
                                    onclick="return confirm('이 사용자의 관리자 권한을 변경하시겠습니까?');">
                                {{ '관리자해제' if user.is_admin else '관리자부여' }}
                            </button>
                        </form>
                    {% else %}
                        <small class="text-muted">자기계정</small>
                    {% endif %}
                </td>
                <td>
                    {% if user.id != current_user.id %}
                        <a href="{{ url_for('adminx.edit_user', user_id=user.id) }}" class="btn btn-sm btn-info">수정</a>
                    {% else %}
                        <small class="text-muted">불가</small>
                    {% endif %}
                </td>
                <td>
                    {% if user.id != current_user.id %}
                        <form method="POST" action="{{ url_for('adminx.delete_user', user_id=user.id, search=search_query, page=pagination.page, is_admin=is_admin_query, is_active=is_active_query, created_at=created_at_query) }}" style="display:inline;" class="ms-1">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('정말로 {{ user.username }} 사용자를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.');">
                                삭제
                            </button>
                        </form>
                    {% else %}
                        <small class="text-muted">불가</small>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# 페이지네이션 링크 #}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('adminx.manage_users', page=pagination.prev_num, search=search_query, is_admin=is_admin_query, is_active=is_active_query, created_at=created_at_query) }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
        </li>
        {% endif %}

        {% for p in pagination.iter_pages() %}
            {% if p %}
                {% if p == pagination.page %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ p }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('adminx.manage_users', page=p, search=search_query, is_admin=is_admin_query, is_active=is_active_query, created_at=created_at_query) }}">{{ p }}</a></li>
                {% endif %}
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('adminx.manage_users', page=pagination.next_num, search=search_query, is_admin=is_admin_query, is_active=is_active_query, created_at=created_at_query) }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
        </li>
        {% endif %}
    </ul>
</nav>

{% else %}
<div class="alert alert-info" role="alert">
    등록된 사용자가 없습니다.
</div>
{% endif %}

<style>
/* 모바일 (기본값) */
.user-create-btn {
    width: 100%; /* 모바일에서 전체 폭 */
}

/* Medium (md) 이상 화면 (768px 이상) */
@media (min-width: 768px) {
    .user-create-btn {
        width: auto; /* 데스크톱에서 내용에 맞춰 자동 크기 */
    }
}
</style>
{% endblock %}